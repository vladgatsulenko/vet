{% extends 'base.html.twig' %}

{% block title %}{{ 'catalogTitle'|trans }}{% endblock %}

{% block body %}
<div class="row">
  <aside class="col-lg-3 mb-4">
    <form method="get" action="{{ path('app_catalog_index') }}" autocomplete="off" novalidate>
      <div class="mb-3">
        <label class="form-label">{{ 'catalogSearchLabel'|trans }}</label>
        <input
          class="form-control form-control-sm"
          type="search"
          name="search"
          placeholder="{{ 'navBarPlaceholder'|trans }}"
          aria-label="{{ 'navBarAria'|trans }}"
          value="{{ app.request.get('search') ?: app.request.get('query') }}"
          data-autocomplete="product"
          data-suggest-url="{{ path('app_search_suggest') }}"
        >
      </div>

      <div class="mb-3" id="manufacturers-filter">
        <label class="form-label">{{ 'catalogManufacturerLabel'|trans }}</label>

        {% set maxVisible = 1 %} 
        <div id="manufacturers-list" class="d-grid gap-1">
          {% for m in model.manufacturers %}
            <div
              class="form-check manufacturer-item {% if loop.index > maxVisible %}d-none extra-manufacturer{% endif %}"
              data-manufacturer-index="{{ loop.index }}"
            >
              <input
                class="form-check-input"
                type="checkbox"
                id="manufacturer_{{ m.id }}"
                name="manufacturers[]"
                value="{{ m.id }}"
                {% if model.selectedManufacturers is defined and m.id in model.selectedManufacturers %}checked{% endif %}
              >
              <label class="form-check-label" for="manufacturer_{{ m.id }}">{{ m.name|e }}</label>
            </div>
          {% else %}
            <div class="text-muted small">{{ 'catalogManufacturerNone'|trans }}</div>
          {% endfor %}
        </div>

        {% if model.manufacturers|length > maxVisible %}
          <button
            type="button"
            id="manufacturers-toggle"
            class="btn btn-link p-0 mt-2"
            aria-expanded="false"
            aria-controls="manufacturers-list"
            data-show="{{ 'catalogManufacturersShowMore'|trans({'%n%': (model.manufacturers|length - maxVisible)}) }}"
            data-hide="{{ 'catalogManufacturersShowLess'|trans }}"
          >
            {{ 'catalogManufacturersShowMore'|trans({'%n%': (model.manufacturers|length - maxVisible)}) }}
          </button>
        {% endif %}

        <noscript>
          <div class="text-muted small mt-2">
            {{ 'catalogJsDisabledShowAll'|trans }}
          </div>
        </noscript>
      </div>

      <div class="mb-3">
        <label class="form-label">{{ 'catalogGroupLabel'|trans }}</label>
        <select name="group" class="form-select">
          <option value="">{{ 'catalogGroupAny'|trans }}</option>
          {% for g in model.groups %}
            <option value="{{ g.id }}" {{ model.selectedGroup is not null and model.selectedGroup == g.id ? 'selected' : '' }}>
              {{ g.name|e }}
            </option>
          {% endfor %}
        </select>
      </div>

      <div class="mb-3">
        <label class="form-label">{{ 'catalogSpeciesLabel'|trans }}</label>
        <select name="species" class="form-select">
          <option value="">{{ 'catalogGroupAny'|trans }}</option>
          {% for s in model.species %}
            <option value="{{ s.id }}" {{ model.selectedSpecies is not null and model.selectedSpecies == s.id ? 'selected' : '' }}>
              {{ s.name|e }}
            </option>
          {% endfor %}
        </select>
      </div>

      <div class="d-flex gap-2">
        <button type="submit" class="btn btn-primary">{{ 'catalogFilterApply'|trans }}</button>
        <a href="{{ path('app_catalog_index') }}" class="btn btn-outline-secondary">{{ 'catalogFilterReset'|trans }}</a>
      </div>
    </form>
  </aside>

  <main class="col-lg-9">
    {% if model.products is empty %}
      <div class="alert alert-warning">{{ 'catalogNoResults'|trans }}</div>
    {% else %}
      <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-3">
        {% for product in model.products %}
          <div class="col">
            {{ include('catalog/_card.html.twig', {'product': product}) }}
          </div>
        {% endfor %}
      </div>

      {% set routeParams = {
        search: model.search,
        group: model.selectedGroup,
        species: model.selectedSpecies
      } %}

      {% include 'partials/_pagination.html.twig' with {
        pagination: model.pagination,
        route: 'app_catalog_index',
        routeParams: routeParams
      } %}
    {% endif %}
  </main>
</div>
{% endblock %}

{% block extra_scripts %}
  {{ parent() }}
  <script>
    (function () {
      const toggle = document.getElementById('manufacturers-toggle');
      if (!toggle) return;

      const extraItems = document.querySelectorAll('.extra-manufacturer');
      if (!extraItems || extraItems.length === 0) return;

      const showText = toggle.dataset.show || toggle.textContent.trim();
      const hideText = toggle.dataset.hide || '{{ "catalogManufacturersShowLess"|trans }}';

      toggle.addEventListener('click', function () {
        const expanded = this.getAttribute('aria-expanded') === 'true';

        extraItems.forEach(function (el) {
          if (expanded) {
            el.classList.add('d-none');
          } else {
            el.classList.remove('d-none');
          }
        });

        this.setAttribute('aria-expanded', String(!expanded));
        this.textContent = expanded ? showText : hideText;
      });
    })();
  </script>

  <style>
    #manufacturers-list { max-height: none; }
    .manufacturer-item { margin-bottom: 0.25rem; }
  </style>
{% endblock %}
